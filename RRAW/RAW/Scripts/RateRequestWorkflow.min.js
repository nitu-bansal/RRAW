/// <reference path="http://ajax.googleapis.com/ajax/libs/jquery/1.6.2/jquery.min.js" />
/// <reference path="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js" />
/// <reference path="Tabs.min.js" />
var errCode = -1;
var quotes;
var rates;
var workflows;
var maxJSONCollectionCount = 2;


var users;
var decnos;

$(document).ready(function () {
    GetAllMasters();
    $(".form").validationEngine('attach');

})

function GetAllMasters() {

    RRAW.WebServices.Authentications.GetAllMasters(AuthenticationToken(), onSuccessOfGetAllMasters, onFailureOfGetAllMasters);

}
function onFailureOfGetAllMasters(res) {
    window.location = "Errors.aspx?Operation=GetAllMasters&ExceptionType=" + res._exceptionType + "&Msg=" + res._message + "&StackTrace=" + res._stackTrace + "&TimedOut=" + res._timedOut;
}

function onSuccessOfGetAllMasters(res) {
    var masters = res;

    if (masters == undefined) {
        if (mastersJSONCollectionCount <= maxJSONCollectionCount) {
            mastersJSONCollectionCount++;
            GetAllMasters();
            return;
        }
    }
    onSuccessOfGetAllClients(masters["GetAllClients"]);
    
    
    users = masters["GetAllUsers"];
    mastersLoadComplete = true;
}
function onSuccessOfGetAllClients(res) {
    if (Number(res) != NaN && (res == errCode || res == 0)) {
        DisplayError("Unknown error has occured. Please contact Administrator");
        return errCode;
    }
    var Clients = res;    
    $("#cmbClient_workflow").children().remove();    
    $('#cmbClient_workflow').append($("<option></option>").attr("value", "0").text("Select"));


    $.each(Clients, function (key, val) {        
        $('#cmbClient_workflow').append($("<option></option>").attr("value", key).text(val));

    });

}

//----------------------------------------------------Workflow------------------------------------------------------------------------

function RefillAllData_Workflow() {
    RRAW.WebServices.Authentications.GetCustomizeWorkflowUI(GetCookie("AuthenticationToken"), $("#cmbClient_workflow option:selected").attr('value'), $("#cmbMode_workflow option:selected").attr('value'), onSuccessOfGetCustomizeWorkflowUI);
}

function onSuccessOfGetCustomizeWorkflowUI(res) {
    if (res["AuthenticationError"] != undefined) {
        window.location = res["AuthenticationError"][0];
    }
    workflows = res;
    Fillworkflow();
}

$("#divAddMoreCharges").click(function () {

    if ($("tr[id^='TrWorkflow_']").length == 0) {
        AppendBlankRowWithHeader()
    }
    else {
        AppendBlankRow();
    }

});

function AppendBlankRow() {
    var Color = "#800000";
    var WId;
    WId = ($("tr[id^='TrWorkflow_']").length + 1) + "_NewWorkflow";
    if (($("tr[id^='TrWorkflow_']").length + 1) % 2 == 0) {
        $('#tblFormValidation_Workflow').append("<tr id='TrWorkflow_" + WId + "'  style='border:1px solid #DAE3F6;color:" + Color + ";height:25px;'><td>" + CreateDropDownRequired("cmbDecNo_" + WId, "0", decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + WId, "0", users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + WId, "0", users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + WId, "", "", true) + "<td>" + CreateButton("btnInsertWorkflow_" + WId, "0", "0") + "</td></tr>");
    }
    else {
        $('#tblFormValidation_Workflow').append("<tr id='TrWorkflow_" + WId + "'  style='border:1px solid #DAE3F6;background-color:#EFF3FB;color:" + Color + ";height:25px;'><td>" + CreateDropDownRequired("cmbDecNo_" + WId, "0", decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + WId, "0", users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + WId, "0", users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + WId, "", "", true) + "<td>" + CreateButton("btnInsertWorkflow_" + WId, "0", "0") + "</td></tr>");
    }
}

function AppendBlankRowWithHeader() {
    var Color = "#800000";
    $("#divWorkflow").children().remove();
    $("#divWorkflow").append("<div><div style='font-weight:bold;margin-bottom: 10px;color:#800000'>Users Access Format:</div><table border='0'  id='tblFormValidation_Workflow' width='100%'  cellpadding='0' cellspacing='0'><thead><tr style='background-color: #336699 ;color:white;font-size: 12px;font-weight: bold;'><td style='Width:10%;'>DecNo</td><td style='Width:20%;text-align:left;'>User </td><td style='Width:20%;'>Approver</td><td style='Width:15%;text-align:left;'>ApproverTime(HRS)</td><td style='Width:10%;text-align:left;'>AlertTime(HRS)</td><td style='Width:10%;text-align:left;'>Approving level</td><td style='Width:7%;text-align:left;'></td></thead></table> </div>");
    var WId;
    WId = ($("tr[id^='TrWorkflow_']").length + 1) + "_NewWorkflow";
    if (($("tr[id^='TrWorkflow_']").length + 1) % 2 == 0) {
        $('#tblFormValidation_Workflow').append("<tr id='TrWorkflow_" + WId + "'  style='border:1px solid #DAE3F6;color:" + Color + ";height:25px;'><td>" + CreateDropDownRequired("cmbDecNo_" + WId, "0", decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + WId, "0", users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + WId, "0", users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + WId, "", "", true) + "<td>" + CreateButton("btnInsertWorkflow_" + WId, "0", "0") + "</td></tr>");
    }
    else {
        $('#tblFormValidation_Workflow').append("<tr id='TrWorkflow_" + WId + "'  style='border:1px solid #DAE3F6;background-color:#EFF3FB;color:" + Color + ";height:25px;'><td>" + CreateDropDownRequired("cmbDecNo_" + WId, "0", decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + WId, "0", users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + WId, "0", users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + WId, "", "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + WId, "", "", true) + "<td>" + CreateButton("btnInsertWorkflow_" + WId, "0", "0") + "</td></tr>");
    }
}


function Fillworkflow() {
    var Color = "#800000";
    $("#divWorkflow").children().remove();
    $("#divWorkflow").append("<div><div style='font-weight:bold;margin-bottom: 10px;color:#800000'>Users Access Format:</div><table border='0'  id='tblFormValidation_Workflow' width='100%'  cellpadding='0' cellspacing='0'><thead><tr style='background-color: #336699 ;color:white;font-size: 12px;font-weight: bold;'><td style='Width:10%;'>DecNo</td><td style='Width:20%;text-align:left;'>User </td><td style='Width:20%;'>Approver</td><td style='Width:15%;text-align:left;'>ApproverTime(HRS)</td><td style='Width:10%;text-align:left;'>AlertTime(HRS)</td><td style='Width:10%;text-align:left;'>Approving level</td><td style='Width:7%;text-align:left;'></td></thead></table> </div>");
    var i = 0;

    $.each(workflows["CustomizeWorkflowUI"], function (key, val) {
        if (i == 0) {
            $('#tblFormValidation_Workflow').append("<tr style='border:1px solid #DAE3F6;background-color:#EFF3FB;color:" + Color + ";height:25px;'  id='TrWorkflow_" + val.WorkflowId + "'><td>" + CreateDropDownRequired("cmbDecNo_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["DECNO"], decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["UserID"], users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovarID"], users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovalTime"], "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["AlertTime"], "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovingLavel"], "", true) + "<td>" + CreateButton("btnEditWorkflow_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, "1", "0") + "</td></tr>");
            i = 1;
        }
        else {
            $('#tblFormValidation_Workflow').append("<tr style='border:1px solid #DAE3F6;color:" + Color + ";height:25px;'  id='TrWorkflow_" + val.WorkflowId + "'><td>" + CreateDropDownRequired("cmbDecNo_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["DECNO"], decnos, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbUser_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["UserID"], users, "") + "</td>" + "<td>" + CreateDropDownRequired("cmbApprover_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovarID"], users, "") + "</td>" + "<td>" + CreateTextBox("txtApprovalTime_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovalTime"], "", true) + "</td>" + "<td>" + CreateTextBox("txtAlertTime_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["AlertTime"], "", true) + "</td>" + "<td>" + CreateTextBox("txtApprovingLavel_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, val["ApprovingLavel"], "", true) + "<td>" + CreateButton("btnEditWorkflow_" + val.WorkflowId + "_" + val.ClientID + "_" + val.ModeID, "1", "0") + "</td></tr>");
            i = 0;
        }
    });

    if ($("tr[id^='TrWorkflow_']").length == 0) {
        $("#divWorkflow").children().remove();
    }
}

$("[id^='btnInsertWorkflow_']").live("click", function (e) {

    var TransportModeId;
    var ClientID;
    var partId;
    partId = ($(this).attr("id").split('_')[1]).toString() + "_" + ($(this).attr("id").split('_')[2]).toString();

    ClientID = $("#cmbClient_workflow option:selected").attr('value');
    TransportModeId = $("#cmbMode_workflow option:selected").attr('value');

    if ($.isNumeric($("#txtApprovalTime_" + partId).val()) && $.isNumeric($("#txtAlertTime_" + partId).val()) && $.isNumeric($("#txtApprovingLavel_" + partId).val())
     && $("#cmbDecNo_" + partId + " option:selected").attr('value').toString() != "0"
     && $("#cmbUser_" + partId + " option:selected").attr('value').toString() != "0"
     && $("#cmbApprover_" + partId + " option:selected").attr('value').toString() != "0") {
        RRAW.WebServices.Authentications.InsertCustomizeWorkflowUI(ClientID, "TRUE", $("#cmbDecNo_" + partId + " option:selected").attr('value').toString()
        , $("#cmbUser_" + partId + " option:selected").attr('value').toString(), TransportModeId,
        $("#cmbApprover_" + partId + " option:selected").attr('value').toString(),
        $("#txtApprovalTime_" + partId).val(), $("#txtAlertTime_" + partId).val()
        , $("#txtApprovingLavel_" + partId).val(), onSuccessOfInsertCustomizeWorkflowUI);
    }

});

function onSuccessOfInsertCustomizeWorkflowUI(res) {
    if (res == 1) {
        RefillAllData_Workflow();
        $("#lbl_UserWorkflowDetails_Status").css("color", "#00f");
        $("#lbl_UserWorkflowDetails_Status").html('Workflow inserted');
    }
    else {
        $("#lbl_UserWorkflowDetails_Status").css("color", "#f00");
        $("#lbl_UserWorkflowDetails_Status").html('Following workflow is already exists');
    }
}

$("[id^='btnEditWorkflow_']").live("click", function (e) {

    var TransportModeId;
    var ClientID;
    var WorkflowId;

    ClientID = ($(this).attr("id").split('_')[2]).toString();
    WorkflowId = ($(this).attr("id").split('_')[1]).toString();
    TransportModeId = ($(this).attr("id").split('_')[3]).toString();

    if ($.isNumeric($("#txtApprovalTime_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val()) && $.isNumeric($("#txtAlertTime_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val()) && $.isNumeric($("#txtApprovingLavel_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val())
     && $("#cmbDecNo_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString() != "0"
     && $("#cmbUser_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString() != "0"
     && $("#cmbApprover_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString() != "0") {

        RRAW.WebServices.Authentications.UpdateCustomizeWorkflowUI(WorkflowId, ClientID, "TRUE", $("#cmbDecNo_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString()
        , $("#cmbUser_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString(), TransportModeId,
        $("#cmbApprover_" + WorkflowId + "_" + ClientID + "_" + TransportModeId + " option:selected").attr('value').toString(),
        $("#txtApprovalTime_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val(), $("#txtAlertTime_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val()
        , $("#txtApprovingLavel_" + WorkflowId + "_" + ClientID + "_" + TransportModeId).val(), onSuccessOfUpdateCustomizeWorkflowUI);
    }
});
function onSuccessOfUpdateCustomizeWorkflowUI(res) {
    if (res == 1) {
        RefillAllData_Workflow();
        $("#lbl_UserWorkflowDetails_Status").css("color", "#00f");
        $("#lbl_UserWorkflowDetails_Status").html('Workflow updated');
    }
    else {
        $("#lbl_UserWorkflowDetails_Status").css("color", "#f00");
        $("#lbl_UserWorkflowDetails_Status").html('Following workflow is already exists');
    }
}



$("#cmbClient_workflow").change(function () {
    if ($("#cmbClient_workflow option:selected").attr('value').toString() != "0" && $("#cmbMode_workflow option:selected").attr('value').toString() != "0") {
        GetAllDecNoClient();
        RefillAllData_Workflow();
        $("#divAddMoreCharges").fadeIn();
    }
    else {
        $("#divWorkflow").children().remove();
        $("#divAddMoreCharges").fadeOut();
        decnos = ""
    }
    $("#lbl_UserWorkflowDetails_Status").html('');

});

$("#cmbMode_workflow").change(function () {
    if ($("#cmbClient_workflow option:selected").attr('value').toString() != "0" && $("#cmbMode_workflow option:selected").attr('value').toString() != "0") {
        GetAllDecNoClient();
        RefillAllData_Workflow();
        $("#divAddMoreCharges").fadeIn();
    }
    else {
        $("#divWorkflow").children().remove();
        $("#divAddMoreCharges").fadeOut();
        decnos = "";
    }
    $("#lbl_UserWorkflowDetails_Status").html('');
});


function GetAllDecNoClient() {

    RRAW.WebServices.Authentications.GetAllDecNoClient(AuthenticationToken(), $("#cmbClient_workflow option:selected").attr('value').toString(), $("#cmbMode_workflow option:selected").attr('value').toString(), onSuccessOfGetAllDecNoClient, onFailureOfGetAllDecNoClient);

}
function onFailureOfGetAllDecNoClient(res) {
    window.location = "Errors.aspx?Operation=GetAllDecNoClient&ExceptionType=" + res._exceptionType + "&Msg=" + res._message + "&StackTrace=" + res._stackTrace + "&TimedOut=" + res._timedOut;
}

function onSuccessOfGetAllDecNoClient(res) {
    var masters = res;

    if (masters == undefined) {
        if (mastersJSONCollectionCount <= maxJSONCollectionCount) {
            mastersJSONCollectionCount++;
            GetAllDecNoClient();
            return;
        }
    }
    decnos = masters["GetAllDecNo"];
}



//------------------------------------------------------Workflow end------------------------------------------------------------------

//--------------------------------------------------General------------------------------------------------------------------------------





function CreateButton(ControlID, JsonVal, IsDisabled) {
    var selct = "";
    if (JsonVal == "1") {
        selct = "<input type='button' id='" + ControlID + "' value='Update'" + ((IsDisabled.toString().toUpperCase() == "TRUE") || (IsDisabled.toString().toUpperCase() == "1") ? " disabled='disabled' " : "") + " />";
    }
    else {
        selct = "<input type='button' id='" + ControlID + "' value='Insert'" + ((IsDisabled.toString().toUpperCase() == "TRUE") || (IsDisabled.toString().toUpperCase() == "1") ? " disabled='disabled' " : "") + " />";
    }
    return selct;
}

function CreateDropDown(ControlID, JsonVal, DataArray, attr) {

    var selct;
    var Options = "";
    $.each(DataArray, function (key, val) {
        selct = "";
        if (key == JsonVal) {
            selct = "selected='selected'";
        }
        Options += "<option value='" + (key) + "' " + selct + ">" + val + "</option>";

    });

    selct = "<select id='" + ControlID + "' style='width:70%'" + attr + " required ><option value='0'>Select</option>" + Options + "</select>";
    return selct;

}

function CreateDropDownRequired(ControlID, JsonVal, DataArray, attr) {

    var selct;
    var Options = "";
    $.each(DataArray, function (key, val) {
        selct = "";
        if (key == JsonVal) {
            selct = "selected='selected'";
        }
        Options += "<option value='" + (key) + "' " + selct + ">" + val + "</option>";

    });

    selct = "<select id='" + ControlID + "' style='width:70%' class='validate[required,funcCall[validateit]]' ValMsg='Select Item'" + attr + " required ><option value='0'>Select</option>" + Options + "</select>";
    return selct;

}

function CreateTextBox(ControlID, JsonVal, attr, create) {
    var selct = "";
    if (create)
        var selct = "<input type='text'  class='validate[required,custom[integer]] text-input'  id='" + ControlID + "' style='width:70%' " + attr + " value='" + JsonVal + "'/>";
    return selct;

}


function DisplayError(errorMessage, control) {
    if (control != undefined) {
        $(control).focus();
    }

    alert(errorMessage);

    return 1;
}


function GetCookie(c_name) {
    var i, x, y, ARRcookies = document.cookie.split(";");
    for (i = 0; i < ARRcookies.length; i++) {
        x = ARRcookies[i].substr(0, ARRcookies[i].indexOf("="));
        y = ARRcookies[i].substr(ARRcookies[i].indexOf("=") + 1);
        x = x.replace(/^\s+|\s+$/g, "");
        if (x == c_name) {
            return unescape(y);
        }
    }
}

function AuthenticationToken() {
    return GetCookie("AuthenticationToken");
}

$('div').scroll(function () {
    $(".form").validationEngine("updatePromptsPosition")
});


function validateit(field, rules, i, options) {
    var ValidationMsg = field.attr('ValMsg');
    var CurrentVal = field.val();
    if (CurrentVal == 0) {
        return ValidationMsg;
    }
    else {
        return true;
    }
}



//-------------------------------------------------------------------------------------------------------------------------------------------------
